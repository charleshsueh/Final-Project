---
title: "script"
author: "Chun-Chien Hsueh"
date: "2025-05-04"
output: html_document
---


```{r}
# Load required packages

library(glmnet)
library(tidyr)
library(readr)
library(ggplot2)
library(dplyr)
library(stats)
library(brms)
library(lme4)
library(foreign)      
library(tidyverse)   
library(here)
library(mgcv)

# 步驟 1: 讀取 ARFF 檔案並整理為 TIDY Data
data <- read.arff(here("data","eye_state.arff")) # 替換為實際檔案路徑

# Check for missing values and basic structure
print(summary(data))
anyNA(data)  # Check for NA values

# Rename columns for clarity
colnames(data) <- c(paste0("Channel", 1:14), "eyeDetection")

# Convert eyeDetection to factor and create a numeric version for LASSO
data$eyeDetection <- factor(data$eyeDetection, levels = c(0, 1), labels = c("Closed", "Open"))
data$eyeDetection_numeric <- as.numeric(data$eyeDetection) - 1  # 0 for Closed, 1 for Open

# Standardize the predictor variables to improve model convergence
data[, 1:14] <- scale(data[, 1:14])

# Prepare data matrix for LASSO (predictors and response)
x <- as.matrix(data[, 1:14])  # Predictor variables (channels)
y <- data$eyeDetection_numeric  # Response variable

# 2. LASSO Variable Selection
# Perform LASSO regression
lasso_model <- cv.glmnet(x, y, family = "binomial", alpha = 1, nfolds = 10)

# Extract coefficients at the optimal lambda
coef_lasso <- coef(lasso_model, s = "lambda.min")
selected_vars <- coef_lasso@Dimnames[[1]][which(coef_lasso != 0)]  # Variables with non-zero coefficients
print("Selected variables by LASSO:")
print(selected_vars)

# Plot LASSO coefficient path
plot(lasso_model, main = "LASSO Coefficient Path")
abline(v = log(lasso_model$lambda.min), lty = 2, col = "red")  # Optimal lambda line

# Plot cross-validation error
plot(lasso_model$lambda, lasso_model$cvm, type = "l", 
     xlab = "log(Lambda)", ylab = "Cross-Validation Error", 
     main = "LASSO CV Error vs Lambda")
points(log(lasso_model$lambda.min), lasso_model$cvm[which.min(lasso_model$cvm)], col = "red", pch = 19)

# Subset data with selected variables
selected_channels <- gsub("Channel", "Channel", selected_vars[selected_vars != "(Intercept)"])
data_selected <- data[, c(selected_channels, "eyeDetection", "eyeDetection_numeric")]

# 3. Linear Regression Modeling (Logistic Regression)
log_model <- glm(eyeDetection ~ ., data = data_selected[, c(selected_channels, "eyeDetection")], family = binomial)
summary(log_model)

# 4. Bayesian Inference (Adjusted)
bayes_model <- brm(eyeDetection ~ ., data = data_selected[, c(selected_channels, "eyeDetection")], 
                   family = bernoulli(), chains = 2, iter = 2000, warmup = 1000, 
                   control = list(adapt_delta = 0.95, max_treedepth = 12))
summary(bayes_model)

# 5. Model Diagnostics - Residuals Analysis
# Residuals for logistic model
residuals_log <- residuals(log_model, type = "deviance")
plot(fitted(log_model), residuals_log, main = "Residuals vs Fitted (Logistic)",
     xlab = "Fitted Values", ylab = "Deviance Residuals")
abline(h = 0, col = "red")

# Residuals for Bayesian model
# Ensure data alignment by removing rows with NA predictions
bayes_fitted <- fitted(bayes_model)
data_selected_complete <- data_selected[complete.cases(bayes_fitted), ]
bayes_fitted_complete <- bayes_fitted[complete.cases(bayes_fitted), ]

# Recalculate residuals with aligned data
residuals_bayes <- data_selected_complete$eyeDetection_numeric - bayes_fitted_complete[, 1]
plot(bayes_fitted_complete[, 1], residuals_bayes, main = "Residuals vs Fitted (Bayesian)",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")

# 6. Presentation and Reporting
# Save a scatter plot with selected channels
if (length(selected_channels) >= 2) {
  ggplot(data, aes_string(x = selected_channels[1], y = selected_channels[2], color = "eyeDetection")) +
    geom_point(alpha = 0.5) +
    labs(title = paste("Scatter Plot:", selected_channels[1], "vs", selected_channels[2], "by Eye Detection"),
         x = selected_channels[1], y = selected_channels[2]) +
    theme_minimal()
  ggsave("selected_channels_scatter.png")
}

# Print key results
cat("T-test p-value (example with Channel1):", t.test(Channel1 ~ eyeDetection, data = data)$p.value, "\n")
cat("Logistic Model Summary:\n", capture.output(summary(log_model)), sep = "\n")

```


